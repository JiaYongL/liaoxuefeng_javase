## Java 代码是怎么运行的

Java 与 C++ 不同，需要运行在 JVM 虚拟机中，而 C++ 可以直接编译成机器码执行。

## 为什么 Java 要运行在虚拟机里

因为 Java 语法复杂，抽象程度很高，难以在硬件上直接运行，所以在 Java 程序运行前需要进行一番转换。另外 Java 语言跨平台的特性也需要 JVM 来保证。

JVM 虚拟机还有另一个好处是托管环境（Managed runtime），可以代替人处理一些代码中冗长且容易出现问题的部分，比如内存管理和垃圾回收。另外 JVM 的托管环境还提供有诸如数组越界、动态类型、安全权限等动态监测。

## Java 虚拟机怎么运行 Java 字节码的？

Java 字节码的运行涉及到 JVM 虚拟机和底层硬件两个部分。

- 从虚拟机角度来说

    执行 Java 代码需要首先将其编译成 class 文件加载到 Java 虚拟机中，加载后的 Java 类被存放在方法区(Method Area)中，实际运行时虚拟机会执行方法区内的代码。

    Java 虚拟机与 X86 机器一样也会在内存中划分出堆和栈来存储运行时数据。

    不同的是 Java 会将栈细分为面向 Java 方法的 Java 方法栈和面向本地方法（用 C++ 写的 Native 方法）的本地方法栈，以及存放各个线程执行位置的 PC 寄存器。

    ![1](https://static001.geekbang.org/resource/image/ab/77/ab5c3523af08e0bf2f689c1d6033ef77.png)

    运行时每当调用进入一个 Java 方法，Java 虚拟机会在当前线程的 Java 方法栈中生成一个栈帧，用于存放局部变量以及字节码的操作数。这个栈帧的大小是提前计算好的而且 Java 虚拟机不要求栈帧在内存中连续分布。

    退出当前执行的方法时，不管是正常返回还是异常返回， Java 虚拟机均会弹出当前线程的栈帧并舍弃。

- 从硬件角度看

    Java 字节码无法直接运行，因此需要 Java 虚拟机将字节码翻译成机器码。

    HotSpot 里有两种形式：解释执行和即时编译。

    ![2](https://static001.geekbang.org/resource/image/5e/3b/5ee351091464de78eed75438b6f9183b.png)

    前者优势是无需等待编译，后者优势是实际运行速度更快。HotSpot 默认采用混合模式，综合了解执行和即时编译两者的优点，先解释执行字节码，而后将其中反复执行的热点代码以方法为单位进行即时编译。

## Java 虚拟机的运行效率怎么样

Java 虚拟机的即时编译采用二八原则，即百分之二十的代码占据百分之八十的计算资源。

对于大部分不常用的代码，采用解释执行即可，对于常用代码采用即时编译。

为满足不同用户场景的需求，HotSpot 内置多种即时编译器：C1、C2 和 Graal。 

C1 叫 Client 编译器，面向的是对启动性能有要求的客户端 GUI 程序，采用的优化手段相对简单，编译时间较短。

C2 叫 Server 编译器，面向的是对峰值性能有要求的服务端程序，采用的优化手段相对复杂，编译时间较长。

即时编译可能会使 Java 程序的性能达到甚至超过静态编译的 C++ 语言的性能。

HotSpot 装载了多个不同的即时编译器，以便在编译时间和生成代码的执行效率之间做取舍。
